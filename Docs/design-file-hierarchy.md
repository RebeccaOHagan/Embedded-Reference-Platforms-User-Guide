<p align="right">
            Read this page in other languages:<a href="../docs-jp/Docs/design-file-hierarchy.md">日本語</a>    <table style="width:100%"><table style="width:100%">
  <tr>

<th width="100%" colspan="6"><img src="https://github.com/Xilinx/Image-Collateral/blob/main/xilinx-logo.png?raw=true" width="30%"/><h1>Vitis Software Platform: Embedded Vision Reference Platforms User Guide 2019.2 (UG1265)</h1>
</th>

  </tr>
  <tr>
    <td width="17%" align="center"><a href="../README.md">1. Introduction</a></td>
    <td width="16%" align="center"><a href="overview.md">2. Overview</a></td>
    <td width="17%" align="center"><a href="software-tools-system-requirements.md">3. Software Tools and System Requirements</a></td>
    <td width="17%" align="center">4. Design File Hierarchy</td>
</tr>
<tr>
    <td width="17%" align="center"><a href="operating-instructions.md">5. Installation and Operating Instructions</a></td>
    <td width="16%" align="center"><a href="tool-flow-tutorials.md">6. Tool Flow Tutorials</a></td>
    <td width="17%" align="center"><a href="run-application.md">7. Run the Application</a></td>
    <td width="17%" align="center"><a href="platform-details.md">8. Platform Details</a></td>    
  </tr>
<tr>
    <td width="17%" align="center" colspan="2"><a href="known-issues-limitations.md">9. Known Issues and Limitations</a></td>
    <td width="16%" align="center" colspan="2"><a href="additional-references.md">10. Additional References</a></td>
</tr>
</table>

# 4. Design File Hierarchy and Build from Sources
- [4.1. Platform Source Structure](#41-platform-source-structure)
- [4.2. Platform Build Instructions](#42-platform-build-instructions)
- [4.3. Single Sensor Demo Design](#43-single-sensor-demo-design)
- [4.4. 8-stream VCU + CNN Demo Design](#44-8-stream-vcu--cnn-demo-design)
- [4.5. ZCU104 Smart Camera Demo Design](#45-zcu104-smart-camera-demo-design)

The design files for this user guide on each platform are divided into two parts: the Vitis™ platform and the sample designs. The Vitis platform includes platform hardware specifications and software environments for applications to run. Sample designs are application-level designs. They include acceleration kernels that run on the programmable logic (PL) and software applications that run on the environment (domain) that the platform provides.  

Zynq® UltraScale+™ MPSoC embedded vision platform ZIP files are released with the pre-built binary and source files. Pre-built Vitis platforms are ready to use for application developers. Vitis embedded platform source files can be referenced when you wish to customize the platforms.

Platform sources are provided in a Makefile package format on [GitHub](https://github.com/Xilinx/Vitis_Embedded_Platform_Source/tree/2019.2/Xilinx_Official_Platforms). These sources are used to build the platform as well as the sysroot required to build the applications. To build the platform from sources, install the Vivado® Design Suite and PetaLinux tools. 

To build the acceleration kernel, install the Vitis™ core development kit.

Demo application source files and pre-built binaries are provided in the packages with "Demo" in the name on the [2019.2 Vitis Embedded Platform download page](https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/embedded-platforms.html).

The sample applications are built as GStreamer plugins with test designs to exercise them. The Vitis core development kit and cross-compilation sysroot generated by the Vitis platform are both required to create projects and build sample applications.

## 4.1. Platform Source Structure

The structure of the platform sources is as follows: 

```
<pfm_name>
├── README.md
├── vivado
├── petalinux
├── scripts
└── Makefile
```

  * `vivado` contains the sources to generate the XSA file, which is the the hardware component of the platform.

  * `petalinux` contains the software recipes to generate required software components of the platform, such as the boot and Linux images. This directory contains the PetaLinux project directory based on the Vivado project of the platform. This directory also contains the custom Linux components required by the platform included in ``/project-spec`` in the form of bitbake recipes and appends. For example, Xilinx Runtime (XRT) and the dependent components used in an acceleration platform are placed here. Custom layers can also be included under ``/project-spec``.

  * `scripts` contains the Tcl script to generate the platform using the software and hardware components generated in the previous build steps.

  * `Makefile` contains the build targets to build all the components of the platform. 

## 4.2. Platform Build Instructions

1. cd to ``<pfm_name>``.

2. To build the platform with default sources, run the following command: 

   ```
       make all
   ```

3. To modify hardware sources and build the platform, run the following command:

   ```
       make all
   ```

4. To modify the software only (after the hardware is built using `make xsa`) and build the platform, run the following command:

   ```
       make petalinux_proj XSA_DIR=<xsa_path>
       make pfm XSA_DIR=<xsa_path>
   ```
   
4. To build the sysroot, run the following command.

**:pushpin: NOTE**: The platform should be configured before building the sysroot. Ensure that PetaLinux is in a built state by running  the command ``make petalinux_proj XSA_DIR=<xsa_path>`` _before_ running the sysroot build command.

   ```
       make peta_sysroot
   ```
 
## 4.3. Single Sensor Demo Design

The ``zcu104_ss`` platform can be worked with at two levels: the pre-built level, and the source code level. Using the [platform source code](https://github.com/Xilinx/Vitis_Embedded_Platform_Source/tree/2019.2/Xilinx_Official_Platforms), you can generate platform binaries, or you can perform customizations to generate a custom platform. If you would prefer to work with the [pre-built platforms](https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/embedded-platforms.html) to save time, you can download and use the ``zcu104_ss`` platform directly. 

The below directory structures show three types of deliverables for the ZCU104 Single Sensor demo design. They are as follows:

1. The platform generation source files.
2. The generated pre-built platform files.
3. The Vitis kernel samples, GStreamer application workspaces, and ready-to-test SD card images. The samples provided with the Single Sensor platform include three live I/O examples. The live I/O examples take live video input from a video source and output live video on a display.

### 4.3.1 Sources

The sources are available on GitHub at the [Platform Source Code page](https://github.com/Xilinx/Vitis_Embedded_Platform_Source/tree/2019.2/Xilinx_Official_Platforms).

```
zcu104_ss
├── README.txt
├── vivado
├── petalinux
├── scripts
├── Makefile

```
### 4.3.2 Pre-built platform

The pre-built platform generated using the sources mentioned above is available at the [Embedded Platforms page](https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/embedded-platforms.html).

The ``zcu104_ss`` pre-built platform (see [section 3.2](software-tools-system-requirements.md#32-software) to download) directory contains the following components:

  * `hw` contains the .xsa file describing the hardware platform.
  * `sw` contains software; bootloaders and other code, and support files for the processors on the ZCU104 target board.
  
```
    └── zcu104_ss
        ├── hw
        │   └── zcu104_ss.xsa
        ├── sw
        │   ├── zcu104_ss
        │   │   ├── boot
        |   |   |   ├── bl31.elf  
        |   |   |   ├── fsbl.elf
        |   |   |   ├── linux.bif
        |   |   |   ├── pmufw.elf
        |   |   |   └── u-boot.elf
        |   │   ├── xrt
        |   |   |   ├── image
        |   |   |   |   ├── image.ub
        |   |   |   |   ├── init.sh
        |   |   |   |   └── platform_desc.txt
        |   │   ├── pre-built
        |   |   |   |   └── BOOT.BIN
        │   │   └── qemu
        │   └── zcu104_ss.spfm
        └── zcu104_ss.xpfm
        
```

### 4.3.3 Workspaces

The Vitis kernels and demo application workspaces to run on the ``zcu104_ss`` platform are available at the [Embedded Platforms page](https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/embedded-platforms.html).

  * `samples` contains the sample Vitis kernel code based on xfopencv kernels. Each sample directory contains a JSON file describing the build process. These are the sample kernels that appear in the Template dialog when creating a new accelerator project using the platform.
      * `live_IO` projects are more complex, and are built in several steps. See <a href="run-application.md">Run the Application</a>.  
  * The ``ws_f2d``, ``ws_of``, and ``ws_sv`` directories contain a workspace directory structure you can use to build the GStreamer applications to test the `live_IO` samples. See <a href="run-application.md">Run the Application</a>.
  * `sd_card` contains pre-built SD card images that enable you to run the live I/O example applications on the ZCU104 board.

```
├── samples
│   ├── live_IO
│   │   ├── filter2d
│   │   ├── optical_flow
│   │   ├── stereo
├── ws_f2d
│   ├── gst
│   │   ├── allocators
│   │   ├── base
│   │   └── plugins
│   ├── xcl_filter2d
│   ├── xrtutils
│   └── scripts
├── ws_of
│   ├── gst
│   │   ├── allocators
│   │   ├── base
│   │   └── plugins
│   ├── xcl_opticalflow
│   ├── xrtutils
│   └── scripts
├── ws_sv
│   ├── gst
│   │   ├── allocators
│   │   ├── base
│   │   └── plugins
│   ├── xcl_stereo
│   ├── xrtutils
│   ├── hls_includes
│   └── scripts
├── sd_card
│   ├── filter2d
│   ├── optical_flow
│   ├── stereo

```
## 4.4. 8-stream VCU + CNN Demo Design

The ``zcu104_vcu_ml`` platform can be worked with at two levels: the pre-built level, and the source code level. Using the [platform source code](https://github.com/Xilinx/Vitis_Embedded_Platform_Source/tree/2019.2/Xilinx_Official_Platforms), you can generate platform binaries, or you can perform customizations to generate a custom platform. If you would prefer to work with the [pre-built platforms](https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/embedded-platforms.html) to save time, you can download and use the ``zcu104_vcu_ml`` platform directly. 

The below directory structures show the three types of deliverables for the zcu104_vcu_ml demo design. They are as follows:  

1. The platform generation source files.
2. The generated pre-built platform files.
3. The Vitis DPU kernel samples, GStreamer application workspaces, and ready-to-test SD card images.

### 4.4.1 Sources

The sources are available on GitHub at the [Platform Source Code page](https://github.com/Xilinx/Vitis_Embedded_Platform_Source/tree/2019.2/Xilinx_Official_Platforms).

```
zcu104_vcu_ml
├── README.txt
├── vivado
├── petalinux
├── scripts
├── Makefile

```

### 4.4.2 Pre-Built Platform

The pre-built platform generated using the sources mentioned above is available at the [Embedded Platforms page](https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/embedded-platforms.html).

The ``zcu104_vcu_ml`` pre-built platform (see [section 3.2](software-tools-system-requirements.md#32-software) to download) directory contains the following components:

  * `hw` contains the .xsa file describing the hardware platform.
  * `sw` contains software; bootloaders and other code, and support files for the processors on the ZCU104 target board.
  
```
    └── zcu104_vcu_ml
        ├── hw
        │   └── zcu104_vcu_ml.xsa
        ├── sw
        │   ├── zcu104_vcu_ml
        │   │   ├── boot
        |   |   |   ├── bl31.elf  
        |   |   |   ├── fsbl.elf
        |   |   |   ├── linux.bif
        |   |   |   ├── pmufw.elf
        |   |   |   └── u-boot.elf
        |   │   ├── xrt
        |   |   |   ├── image
        |   |   |   |   ├── image.ub
        |   |   |   |   ├── init.sh
        |   |   |   |   └── platform_desc.txt
        |   │   ├── pre-built
        |   |   |   |   └── BOOT.BIN
        │   │   └── qemu
        │   └── zcu104_vcu_ml.spfm
        └── zcu104_vcu_ml.xpfm
        
```

### 4.4.3 Workspaces

The Vitis DPU kernel and the demo application workspaces to run on the ``zcu104_vcu_ml`` platform are available at the [Embedded Platforms page](https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/embedded-platforms.html).

The ``zcu104_vcu_ml`` worksapces (see [section 3.2](software-tools-system-requirements.md#32-software) to download) directory contains the following components:

  * `DPU` contains the Xilinx Deep Learning Processor Unit (DPU) Vitis kernel. It also has the configuration files to be updated before running the Makefile under the `DPU/prj/` directory  
  * The `gst``, ``gstsdxfacedetect``, ``gstsdxtrafficdetect``, ``xrtutils``, and ``rtsp`` workspaces contain a workspace directory structure you can use to build the GStreamer applications to test the DPU Vitis kernel. See <a href="run-application.md">Run the Application</a>.
  * `sd_card` contains pre-built SD card images that enable you to run the live I/O example applications on the ZCU104 board.

```

├── DPU       
|   ├── dpu_ip
│   │   ├── dpu_eu_v3_1_0
│   │   └── Vitis
|   ├── prj    
|   |   └── Config_file        
|   |   └── doc            
|   |   └── dpu_conf.h
|   |   └── kernel_xml            
|   |   └── Makefile            
|   |   └── scripts  
├── gst
│   ├── allocators
│   ├── base
├── gstsdxfacedetect
├── gstsdxtrafficdetect
├── xrtutils
├── rtsp

```
The contents of``sdcard`` has the ready-to-test pre-built binary images with files as follows:

```
sdcard
├── dpu.xclbin
└── image.ub
└── 8_ch_face.sh
└── 8_ch_traffic_face.sh
└── 8_ch_traffic.sh
└── BOOT.BIN
└── demo_inputs
└── inputs.conf
└── libdpumodeldensebox.so
└── libdpumodelssd.so
└── libdpuaol.so
└── libhineon.so
└── libgstsdxbase.so
└── libgstsdxfacedetect.so
└── libgstsdxtrafficdetect.so
└── libgstxclallocator.so
└── libn2cube.so
└── libxrtutils.so
└── qos.sh
└── UENV.TXT
└── README.txt
└── setup.sh
└── urls_demo_2019_1080p.sh
└── xilinx_8_1080p.jpg

```
## 4.5. ZCU104 Smart Camera Demo Design

The ``zcu104_smart_camera`` platform can be worked with at two levels: the pre-built level, and the source code level. Using the [platform source code](https://github.com/Xilinx/Vitis_Embedded_Platform_Source/tree/2019.2/Xilinx_Official_Platforms), you can generate platform binaries, or you can perform customizations to generate a custom platform. If you would prefer to work with the [pre-built platforms](https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/embedded-platforms.html) to save time, you can download and use the ``zcu104_smart_camera`` platform directly. 

The below directory structures shows three kind of deliverables for zcu104_vcu_ml demo design. They are as follows:

1 The platform generation source files. 
2. The generated pre-built platform files.
3. The Vitis DPU kernel samples, GStreamer application workspaces, and ready-to-test SD card images.

### 4.5.1 Sources

The sources are available on GitHub at the [Platform Source Code page](https://github.com/Xilinx/Vitis_Embedded_Platform_Source/tree/2019.2/Xilinx_Official_Platforms).

```
zcu104_smart_camera
├── README.txt
├── vivado
├── petalinux
├── scripts
├── Makefile

```

### 4.5.2 Pre-Built Platform

The pre-built platform generated using the sources mentioned above is available at the [Embedded Platforms page](https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/embedded-platforms.html).

The ``zcu104_smart_camera`` pre-built platform (see [section 3.2](software-tools-system-requirements.md#32-software) to download) directory contains the following components:

  * `hw` contains the .xsa file describing the hardware platform.
  * `sw` contains software; bootloaders and other code, and support files for the processors on the ZCU104 target board.
  
```
    └── zcu104_smart_camera
        ├── hw
        │   └── zcu104_smart_camera_xilinxisp.xsa
        ├── sw
        │   ├── zcu104_smart_camera_xilinxisp
        │   │   ├── boot
        |   |   |   ├── bl31.elf  
        |   |   |   ├── fsbl.elf
        |   |   |   ├── linux.bif
        |   |   |   ├── pmufw.elf
        |   |   |   └── u-boot.elf
        |   │   ├── xrt
        |   |   |   ├── image
        |   |   |   |   ├── image.ub
        |   |   |   |   ├── init.sh
        |   |   |   |   └── platform_desc.txt
        |   │   ├── pre-built
        |   |   |   |   └── BOOT.BIN
        │   │   └── qemu
        │   └── zcu104_smart_camera_xilinxisp.spfm
        └── zcu104_smart_camera_xilinxisp.xpfm
       
```
### 4.5.3 Workspaces

The Vitis DPU kernel and the demo application workspaces to run on the ``zcu104_smart_camera`` platform are available at the [Embedded Platforms page](https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/embedded-platforms.html).

The ZCU104 Smart Camera workspaces (see [section 3.2](software-tools-system-requirements.md#32-software) to download) contain the following components:

* `dpu` contains the DPU RTL kernel. Scripts and Makefiles are included in the DPU project to build with the Smart Camera platform using the Vitis software platform. More about the DPU kernel can be explored [here](https://github.com/Xilinx/Vitis-AI/tree/master/DPU-TRD).
* `media-ctl_src` contains source files with which you can rebuild the `sdcard/media-ctl` binary.
* `gst, gstsdxfacedetect, xrtutils` workspaces contain the required sources to build the application, libraries (other than DNNDK libraries), and GStreamer plugin. These are used to run the demo.
* `sdcard` contains pre-built SD card images that enable you to run the ZCU104 Smart Camera demo.

```
├── dpu
│   ├── dpu_ip
│   │   ├── dpu_eu_v3_1_0/
│   │   └── Vitis/
│   └── prj
│   │   ├── Vitis
│   │   │   ├── config_file/
│   │   │   └── doc
│   │   │   └── dpu_conf.vh
│   │   │   └── scripts
│   │   │   └── Makefile
│   │   │   └── README.md
│   │   │   └── strip_interconnects.tcl
│   └── Makefile
├── media-ctl_src
├── workspaces
├── gst
│   ├── allocators
│   └── base
└── xrtutils
└── gstsdxfacedetect
└── sdcard

```


The contents of ``sdcard``, as part of the `zcu104_smart_camera_xilinxisp_2019_2` platform, are for evaluation of the Xilinx ISP design only.

```
sdcard
├── BOOT.BIN
└── iamge.ub
└── dpu.xclbin
└── demo.sh
└── libgstsdxbase.so
└── libgstxclallocator.so
└── libxrtutils.so
└── libdpumodeldensebox.so
└── libgstsdxfacedetect.so
└── libn2cube.so
└── libhineon.so
└── libdpuaol.so
└── rtsp
└── xmedia-ctl
└── README.txt

```

The Regulus ISP ``sdcard`` content is not part of the `zcu104_smart_camera_xilinxisp_2019_2` package, and is released as a separate package and as an image-only package.

```
zcu104_smart_camera_regulusisp/sdcard
├── BOOT.BIN
└── iamge.ub
└── dpu.xclbin
└── demo.sh
└── libgstsdxbase.so
└── libgstxclallocator.so
└── libxrtutils.so
└── libdpumodeldensebox.so
└── libgstsdxfacedetect.so
└── libn2cube.so
└── libhineon.so
└── libdpuaol.so
└── rtsp
└── xmedia-ctl
└── isp.conf
└── ispctl.elf
└── ISP4K-license-190311.txt
└── IMPORTANT_NOTICE_CONCERNING_THIRD_PARTY_CONTENT.txt
└── README.txt

```
The hardware design for Regulus ISP can be recreated by replacing the Gamma and Demosaic components of the `hw/zcu104_smart_camera.xsa` design with the Regulus ISP4k IP. Some data converters are required around the Regulus ISP4k IP, because the input/output connectivity is different. 

For the software part, there is no Linux v4l2 driver to program the ISP. The ISP software `ispctl.elf` programs the IP using a Linux UIO driver. A v4l2 driver is still required to configure the v4l2 media pipeline. It can be a simple v4l2 driver (no hardware configuration required) and sets the format ``MEDIA_BUS_FMT_UYVY8_1X16`` for the source and ``MEDIA_BUS_FMT_SRGGB8_1X8`` for the sink of the media entity. The device tree (`project-spec/meta-user/recipes-bsp/device-tree/files/pl.dtsi` in the `zcu104_smart_camera_xilinxisp_2019_2/petalinux`) needs to be modified to include the ISP4k component and the media pipe can be configured to include the dummy media entity. The media entity in the device tree needs to interface between the entities of ``mipi_csi2_rx_subsystem_0`` and ``v_proc_ss_0`` and looks something like below.

```
v_dummy_0: v_dummy@a2250000 {
<snip>
                                dummy0_in: endpoint {
                                        remote-endpoint = <&csiss_out>;
                                };
                        };

                        port@1 {
                                dummy0_out: endpoint {
                                        remote-endpoint = <&csc_in>;
                                };
                        };
                };
        };
```
<hr/>

:arrow_forward:**Next Topic:**  [5. Installation and Operating Instructions](operating-instructions.md)

:arrow_backward:**Previous Topic:**  [3. Software Tools and System Requirements](software-tools-system-requirements.md)
<hr/>
<p align="center"><sup>Copyright&copy; 2018–2019 Xilinx</sup></p>
